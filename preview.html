<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>运行时预览</title>
    <link rel="stylesheet" href="/client/global.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: #ffffff;
        }
        
        #root {
            width: 100vw;
            height: 100vh;
            overflow: auto;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 16px;
            color: #666;
        }
        
        .error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            flex-direction: column;
            color: #e74c3c;
        }
        
        .error-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .error-message {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">正在加载预览...</div>
    </div>
    
    <script type="module">
        // 应用主题 - 立即同步应用，避免闪烁
        function applyTheme() {
            try {
                const savedThemeId = localStorage.getItem('app.theme');
                // 立即导入主题预加载模块，确保主题同步应用
                import('/client/hooks/use-theme.ts').then(({ preloadTheme }) => {
                    preloadTheme();
                }).catch(err => {
                    console.warn('无法加载主题预加载模块:', err);
                    // 降级处理：异步加载主题
                    if (savedThemeId) {
                        import('/client/theme/themes.ts').then(({ getThemeById }) => {
                            const theme = getThemeById(savedThemeId);
                            if (theme) {
                                const root = document.documentElement;
                                for (const [key, value] of Object.entries(theme.vars)) {
                                    root.style.setProperty(`--${key}`, value);
                                }
                                root.setAttribute("data-theme", theme.id);
                            }
                        }).catch(err => {
                            console.warn('无法加载主题:', err);
                        });
                    }
                });
            } catch (err) {
                console.warn('应用主题失败:', err);
            }
        }
        
        // 从URL参数获取页面数据
        function getPageDataFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const pageId = urlParams.get('id');
            const pageDataParam = urlParams.get('data');
            
            if (pageDataParam) {
                try {
                    return JSON.parse(decodeURIComponent(pageDataParam));
                } catch (err) {
                    console.error('解析页面数据失败:', err);
                }
            }
            
            if (pageId) {
                // 尝试从localStorage获取
                try {
                    const storedPages = localStorage.getItem('studio.pages');
                    if (storedPages) {
                        const pages = JSON.parse(storedPages);
                        return pages.find(p => p.id === pageId);
                    }
                } catch (err) {
                    console.error('从localStorage获取页面数据失败:', err);
                }
            }
            
            return null;
        }
        
        // 显示错误信息
        function showError(title, message) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="error">
                    <div class="error-title">${title}</div>
                    <div class="error-message">${message}</div>
                </div>
            `;
        }
        
        // 初始化预览
        async function initPreview() {
            try {
                // 首先应用主题
                applyTheme();
                
                const pageData = getPageDataFromUrl();
                
                if (!pageData) {
                    showError('页面数据不存在', '请确保URL参数包含有效的页面ID或页面数据');
                    return;
                }
                
                // 设置全局页面数据
                window.pageData = pageData;
                
                // 动态加载预览组件
                const { default: RuntimePreview } = await import('/client/runtime-preview.tsx');
                
                // 创建预览应用实例
                const app = new RuntimePreview();
                app.render(pageData);
                
            } catch (err) {
                console.error('初始化预览失败:', err);
                showError('加载失败', err.message || '预览组件加载失败');
            }
        }
        
        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPreview);
        } else {
            initPreview();
        }
    </script>
</body>
</html>